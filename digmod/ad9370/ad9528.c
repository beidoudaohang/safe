/**************************
* Created by:     XMAN
* Created date:   2016-06-06
* Version:        V1.0
* Descriptions:  
**************************/
#include <linux/spi/spidev.h>  
#include <sys/ioctl.h>
#include <string.h>
#include <fcntl.h>

#include "helios.h"
#include "ad9528.h"
//#include "device.h"
#include "log.h"
#include "ad_dev_api.h"


//ad9528 cmd
#define AD9528_IOC_MAGIC 'k' //majic
#define AD9528_CMD_RESET _IO(AD9528_IOC_MAGIC, 0x20)
#define AD9528_CMD_REFSEL_SET _IOW(AD9528_IOC_MAGIC, 0x21, int)
#define AD9528_CMD_REFSEL_READ _IOR(AD9528_IOC_MAGIC, 0x22, int)

struct ad9528_reg
{
	int reg;
	char dat;
};

struct ad9528_dev
{
	char spi_dev[64];
	char dev[64];
	int spi_fd;
	int ad_fd;
};

static struct ad9528_dev ad9528_d = {
	.spi_dev = "/dev/spidev1.1",
	.dev = "/dev/ad9528-ctl",
	.spi_fd = 0,
	.ad_fd = 0,
};

static struct ad_spi_cfg cfg = {
	.speed = 5000000,
	.bits = 24,
	.mode = SPI_CPHA | SPI_CPOL,
	.delay = 1,
};


#if 1
static const AD9528_REG_STRUC ad9528_conf[] =
{
	{0x000, 0x99},
	{0x00f, 0x01},
	{0x001, 0x00},
	{0x100, 0x1E},
	{0x101, 0x00},
	{0x102, 0x96},
	{0x103, 0x00},
	{0x104, 0x78},
	{0x105, 0x00},
	{0x106, 0x1A},
	{0x107, 0x03},
	//{0x108, 0x59},
	{0x108, 0x49},
	{0x109, 0x04},
	{0x10a, 0x0A},
	{0x10b, 0x00},
	{0x200, 0xE6},
	{0x201, 0x87},
	{0x202, 0x03},
	{0x203, 0x04},
	{0x00f, 0x01},
	{0x203, 0x05},
	{0x00f, 0x01},
	{0x204, 0x13},
	{0x205, 0x2A},
	{0x206, 0x00},
	{0x207, 0x01},
	{0x208, 0x09},
	{0x209, 0x00},
	//{0x300, 0x20},
	{0x300, 0x00},
	{0x301, 0x80},
	//{0x302, 0x04},
	{0x302, 0x09},
	//{0x303, 0x40},
	{0x303, 0x00},
	{0x304, 0x00},
	//{0x305, 0x00},
	{0x305, 0x09},
	{0x306, 0x00},
	{0x307, 0x80},
	{0x308, 0x04},
	{0x309, 0x40},
	//{0x309, 0x00},
	{0x30a, 0x00},
	//{0x30b, 0x00},
	{0x30b, 0x09},
	{0x30c, 0x00},
	{0x30d, 0x80},
	{0x30e, 0x04},
	{0x30f, 0x40},
	{0x310, 0x00},
	{0x311, 0x00},
	{0x312, 0x00},
	{0x313, 0x80},
	//{0x314, 0x04},
	{0x314, 0x09},
	//{0x315, 0x40},
	{0x315, 0x00},
	{0x316, 0x00},
	//{0x317, 0x00},
	{0x317, 0x09},
	{0x318, 0x40},
	{0x319, 0x00},
	{0x31a, 0x04},
	//{0x31b, 0x00},
	{0x31b, 0x40},
	{0x31c, 0x00},
	{0x31d, 0x09},
	{0x31e, 0x00},
	{0x31f, 0x00},
	{0x320, 0x09},
	{0x321, 0x00},
	{0x322, 0x00},
	{0x323, 0x09},
	//{0x324, 0x40},
	{0x324, 0x00},
	{0x325, 0x00},
	//{0x326, 0x00},
	{0x326, 0x09},
	//{0x327, 0x00},
	{0x327, 0x40},
	{0x328, 0x00},
	//{0x329, 0x07},
	{0x329, 0x09},
	{0x32a, 0x00},
	{0x32b, 0x00},
	{0x32c, 0x00},
	{0x32d, 0x00},
	{0x32e, 0x00},
	{0x400, 0x64},
	{0x401, 0x00},
	{0x402, 0x00},
	{0x403, 0x90},
	{0x404, 0x04},
	{0x500, 0x10},
	//{0x501, 0x00},
	//{0x502, 0x00},
	{0x501, 0x34},
	{0x502, 0x09},
	{0x503, 0xFF},
	{0x504, 0xFF},
	{0x505, 0x02},
	{0x506, 0x03},
	{0x507, 0x0C},
	{0x508, 0xE4},
	{0x509, 0x00},
	{0xffe, 0x00},
	{0x00f, 0x01},
	//	{0x203,0x04},
	//	{0x00f,0x01},
	//	{0x203,0x05},
	//	{0x00f,0x01},
	{0x32a, 0x00},
	{0x00f, 0x01},
	{0x32a, 0x01},
	{0x00f, 0x01},
	{0x32a, 0x00},
	{0x00f, 0x01},
	{0x403, 0x91},
	{0x00f, 0x01},

	/*{0x000,0x99},
	{0x00f,0x01},
	{0x001,0x00},
	{0x100,0x1E},
	{0x101,0x00},
	{0x102,0x96},
	{0x103,0x00},
	{0x104,0x78},
	{0x105,0x00},
	{0x106,0x1A},
	{0x107,0x03},
	{0x108,0x49},
	{0x109,0x04},
	{0x10a,0x0A},
	{0x10b,0x00},
	{0x200,0xE6},
	{0x201,0x87},
	{0x202,0x03},
	{0x203,0x04},
	{0x00f,0x01},
	{0x203,0x04},
	{0x00f,0x01},
	{0x204,0x13},
	{0x205,0x2A},
	{0x206,0x00},
	{0x207,0x01},
	{0x208,0x09},
	{0x209,0x00},
	{0x300,0x20},
	{0x301,0x00},
	{0x302,0x04},
	{0x303,0x20},
	{0x304,0x00},
	{0x305,0x00},
	{0x306,0x20},
	{0x307,0x00},
	{0x308,0x04},
	{0x309,0x20},
	{0x30a,0x00},
	{0x30b,0x00},
	{0x30c,0x20},
	{0x30d,0x00},
	{0x30e,0x04},
	{0x30f,0x20},
	{0x310,0x00},
	{0x311,0x00},
	{0x312,0x20},
	{0x313,0x00},
	{0x314,0x04},
	{0x315,0x20},
	{0x316,0x00},
	{0x317,0x00},
	{0x318,0x20},
	{0x319,0x00},
	{0x31a,0x04},
	{0x31b,0x20},
	{0x31c,0x00},
	{0x31d,0x09},
	{0x31e,0x20},
	{0x31f,0x00},
	{0x320,0x09},
	{0x321,0x20},
	{0x322,0x00},
	{0x323,0x09},
	{0x324,0x20},
	{0x325,0x00},
	{0x326,0x00},
	{0x327,0x20},
	{0x328,0x00},
	{0x329,0x07},
	{0x32a,0x00},
	{0x32b,0x00},
	{0x32c,0x00},
	{0x32d,0x00},
	{0x32e,0x00},
	{0x400,0x64},
	{0x401,0x00},
	{0x402,0x00},
	{0x403,0x90},
	{0x404,0x04},
	{0x500,0x10},
	{0x501,0x00},
	{0x502,0x00},
	{0x503,0xFF},
	{0x504,0xFF},
	{0x505,0x02},
	{0x506,0x03},
	{0x507,0x0C},
	{0x508,0xE4},
	{0x509,0x00},
	{0xffe,0x00},
	{0x00f,0x01},
	{0x32a,0x00},
	{0x00f,0x01},
	{0x32a,0x01},
	{0x00f,0x01},
	{0x32a,0x00},
	{0x00f,0x01},
	{0x403,0x91},
	{0x00f,0x01}, */

};
#else
static const AD9528_REG_STRUC ad9528_conf[] =
{
    {0x000, 0x99},

    {0x00f, 0x01},

    {0x001, 0x00},

    {0x100, 0x1E},

    {0x101, 0x00},

    {0x102, 0x96},

    {0x103, 0x00},

    {0x104, 0x78},

    {0x105, 0x00},

    {0x106, 0x1A},

    {0x107, 0x03},

    {0x108, 0x49},

    {0x109, 0x04},

    {0x10a, 0x0A},

    {0x10b, 0x00},

    {0x200, 0xE6},

    {0x201, 0x87},

    {0x202, 0x03},

    {0x203, 0x04},

    {0x00f, 0x01},

    {0x203, 0x05},

    {0x00f, 0x01},

    {0x204, 0x13},

    {0x205, 0x2A},

    {0x206, 0x00},

    {0x207, 0x01},

    {0x208, 0x09},

    {0x209, 0x00},

    {0x300, 0x00},
    {0x301, 0x00},
    {0x302, 0x09},

    {0x303, 0x00},

    {0x304, 0x00},

    {0x305, 0x09},

    {0x306, 0x00},
    {0x307, 0x00},
    {0x308, 0x09},
    {0x309, 0x40},
    {0x30a, 0x00},
    {0x30b, 0x00},
    {0x30c, 0x00},
    {0x30d, 0x00},
    {0x30e, 0x09},
    {0x30f, 0x00},
    {0x310, 0x00},
    {0x311, 0x09},
    {0x312, 0x00},
    {0x313, 0x00},
    {0x314, 0x09},

    {0x315, 0x00},

    {0x316, 0x00},

    {0x317, 0x09},
    {0x318, 0x00},
    {0x319, 0x00},
    {0x31a, 0x09},
    {0x31b, 0x40},
    {0x31c, 0x00},

    {0x31d, 0x09},

    {0x31e, 0x00},

    {0x31f, 0x00},

    {0x320, 0x09},

    {0x321, 0x00},

    {0x322, 0x00},

    {0x323, 0x09},


    {0x324, 0x00},

    {0x325, 0x00},


    {0x326, 0x09},
    {0x327, 0x40},
    {0x328, 0x00},
    {0x329, 0x07},
    {0x32a, 0x00},

    {0x32b, 0x00},

    {0x32c, 0x00},

    {0x32d, 0x00},

    {0x32e, 0x00},

    {0x400, 0x64},

    {0x401, 0x00},

    {0x402, 0x00},

    {0x403, 0x90},

    {0x404, 0x04},

    {0x500, 0x10},

    {0x501, 0x34},

    {0x502, 0x09},

    {0x503, 0xFF},

    {0x504, 0xFF},

    {0x505, 0x02},

    {0x506, 0x03},

    {0x507, 0x0C},

    {0x508, 0xE4},

    {0x509, 0x00},

    {0xffe, 0x00},

    {0x00f, 0x01},

    {0x32a, 0x00},

    {0x00f, 0x01},

    {0x32a, 0x01},

    {0x00f, 0x01},

    {0x32a, 0x00},

    {0x00f, 0x01},

    {0x403, 0x91},

    {0x00f, 0x01},
};

#endif

/********************************funs****************************/
/*
	name:
		ad9528_dev_open(void)
	description:
		open ad9528 dev
*/

int ad9528_dev_open(void)
{
	int ret;

	RLDEBUG("ad9528 init start\n");

	if (!strstr(ad9528_d.spi_dev, "/dev"))
	{
		RLDEBUG("ad9528 spi strstr false,str=%s\n", ad9528_d.spi_dev);
		return -ERR_NODEV;
	}
	if (!strstr(ad9528_d.dev, "/dev"))
	{
		RLDEBUG("ad9528 dev strstr false, str=%s\n", ad9528_d.dev);
		return -ERR_NODEV;
	}

	ad9528_d.spi_fd = open(ad9528_d.spi_dev, O_RDWR);
	if (ad9528_d.spi_fd < 0)
	{
		RLDEBUG("ad9528 spi open false\n");
		return -ERR_OPENFALSE;
	}

	//test_fd = ad9528_d.spi_fd;

	ad9528_d.ad_fd = open(ad9528_d.dev, O_RDWR);
	if (ad9528_d.ad_fd < 0)
	{
		RLDEBUG("ad9528 dev open false\n");
		return -ERR_OPENFALSE;
	}

	ad9528_dev_reset();

	//set spi para
	ret = ioctl(ad9528_d.spi_fd, SPI_IOC_WR_MODE, &(cfg.mode));
	if (-1 == ret)
	{
		RLDEBUG("spidev mode set false\n");
	}
	ret = ioctl(ad9528_d.spi_fd, SPI_IOC_RD_MODE, &(cfg.mode));
	if (-1 == ret)
	{
		RLDEBUG("spidev mode set false\n");
	}

	ret = ioctl(ad9528_d.spi_fd, SPI_IOC_WR_BITS_PER_WORD, &(cfg.bits));
	if (-1 == ret)
	{
		RLDEBUG("spidev BITS set false\n");
	}
	ret = ioctl(ad9528_d.spi_fd, SPI_IOC_RD_BITS_PER_WORD, &(cfg.bits));
	if (-1 == ret)
	{
		RLDEBUG("spidev BITS set false\n");
	}

	ret = ioctl(ad9528_d.spi_fd, SPI_IOC_WR_MAX_SPEED_HZ, &(cfg.speed));
	if (-1 == ret)
	{
		RLDEBUG("spidev speed set false\n");
	}
	ret = ioctl(ad9528_d.spi_fd, SPI_IOC_RD_MAX_SPEED_HZ, &(cfg.speed));
	if (-1 == ret)
	{
		RLDEBUG("spidev speed set false\n");
	}
	return 0;
}

/*
	name:
		ad9528_dev_close(void)
	description:
		close ad9528 dev
*/
int ad9528_dev_close(void)
{
	close(ad9528_d.spi_fd);
	close(ad9528_d.ad_fd);

	return 0;
}

u8 bspAd9528Write ( u16 addr, u32 data)
{

	//ad9528_device_write(addr, data);
	ad_dev_write(ad9528_d.spi_fd, addr, data, &cfg);
	return (RET_SUCC);
}


u32 bspAd9528Read ( u16 addr)
{
	//return (ad9528_device_read(addr));
	return ad_dev_read(ad9528_d.spi_fd, addr, &cfg);
}

/*
  Manual Sync All Outputs
    a. Write REG0x32A=0x01, Write REG0x00F=0x01
    b. Write REG0x32A=0x00, Write REG0x00F=0x01
*/
u8 bspAd9528SynSet(void)
{
    bspAd9528Write(0x32a, 0x01);
    bspAd9528Write(0x00f, 0x01);

    bspAd9528Write(0x32a, 0x00);
    bspAd9528Write(0x00f, 0x01);
    return RET_SUCC;
}

/******************************************************************
AD9528 Initialization Sequence:
    1. Load registers from REG0x00 to REG0x509 in AD9528evb_software_generated_configuration.stp file
    2. Do VCO Calibration
        a. Write REG0x203.bit0=0, Write REG0x00F=0x01
        b. Write REG0x203.bit0=1, Write REG0x00F=0x01
    3. Wait and check PLL2 locked
        a. Write REG0x00F=0x01
        b. Check REG0x508.bit1=1?
        c. If yes, continue step 4
        d. If no, wait and go to 3.a.
    4. Manual Sync All Outputs
        a. Write REG0x32A=0x01, Write REG0x00F=0x01
        b. Write REG0x32A=0x00, Write REG0x00F=0x01
input:    u8  VSW_BYTE refSelect, u32 refFrqKhz, u32 vcxoFrqKhz
output:    none
return:    BSP_OK, BSP_ERR_HARDWARE_VERSION, BSP_ERR_PARAMETER_INVALID,
        BSP_ERR_CLK_NOT_LOCK
description:
config ad952x.
******************************************************************/
u8 ad9528_config (void)
{
	u8 typeflag;
    u32 ad9528_data = 0x0;
    int i;
    int temp = 0;
    u32 timeout = 0;
    RLDEBUG("Start to config AD9528 ......\n");

	if(ad9528_dev_open()) return RET_FAIL;

	// bspAd9528Reset();   /*Ad9528 Reset*/

    RLDEBUG("config AD9528...... \n");
    /*
      1. Load registers from REG0x00 to REG0x509 in
        AD9528evb_software_generated_configuration.stp file
    */
    temp = sizeof(ad9528_conf)/sizeof(AD9528_REG_STRUC);
    for(i=0; i<temp ; i++)
    {
        bspAd9528Write(ad9528_conf[i].reg, ad9528_conf[i].val);
        //DEBUG("bspAd9528Write(%03X, %02x, %d)", ad9528_conf[i].reg,ad9528_conf[i].val, ad9528_conf[i].width);
    }
    // 3.Wait and check PLL2 locked
    // a. Write REG0x00F=0x01
    // b. Check REG0x508.bit1=1?
    // c. If yes, continue step 4
    // d. If no, wait and go to 3.a.
    do{
        bspAd9528Write(0x00f, 0x01);
		usleep(200);
        temp = bspAd9528Read(0x508);  // & 0x02
        usleep(500);
    }while(!(temp & 0x02) && (timeout++ < 100));  // || (temp == 0xff)

    RLDEBUG("bspAd9528Read(0x508)=0x%x\n", temp);


    if(!(temp & 0x02) && (timeout >= 100))
    {
        RLDEBUG("Ad9528 Fail!!.\n\n");
        return RET_FAIL;
    }

	RLDEBUG("bspAd9528Read(0x403)=0x%x\n",bspAd9528Read(0x403));
    // 4. Manual Sync All Outputs
    // a. Write REG0x32A=0x01, Write REG0x00F=0x01
    // b. Write REG0x32A=0x00, Write REG0x00F=0x01
    //bspAd9528SynSet();

    //return bspAd9528LockStat();
	ad9528_dev_close();

	RLDEBUG("Ad9528 Done.\n");
	
	return RET_SUCC;
}

/*
	name:
		ad9528_dev_reset(void)
	description:
		reset ad9528 dev
*/
int ad9528_dev_reset(void)
{
	int ret;

	if (ad9528_d.ad_fd)
	{
		ret = ioctl(ad9528_d.ad_fd, AD9528_CMD_RESET);
		if (ret < 0)
		{
			RLDEBUG("ad9528 reset false\n");
			return ret;
		}
	}

	return 0;
}

/*
	name:
		ad9528_dev_check(void)
	description:
		check ad9528 dev status
*/
int ad9528_dev_check(void)
{
	int temp;

	temp = ad_dev_read(ad9528_d.spi_fd, 0x508, &cfg); // & 0x02

	return (0x02 & temp);
}
